{% extends 'base.html' %} 
{% load static %} 
{% block meta %}
<title>Connectify - Posts in {{community.nama_community}}</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{% endblock meta %} 

{% block content %}
<div class="jumbotron mt-3 p-5 text-white text-center bg-gradient-to-r from-slate-500 to-yellow-100">
  <div class="container">
      <div style="font-size: 28px; font-weight: bold;">{{community.nama_community}} Community</div>
      <div style="margin-top: 8px;">{{community.detail_community}}</div>
      {% if user.is_authenticated %}
      {% if is_leader %}
          <a href="/community/user/{{community.id}}/">
          <button class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-700 rounded-lg text-white" 
          id="invite-button"
          type="button">Invite</button>
          </a>
      
      {% elif not is_member %}
          <button class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-700 rounded-lg text-white" 
          id="join-button"
          type="button">Join</button>
      {% endif %}
      {% endif %}
  </div>
</div>

  <div class="container">
    <div class="row">
      <div class="col-lg-9">
        <div class="container">
            <div class="form-discuss mt-5 py-3 px-3">
              <form method="POST" id="add-post">
                <h2 style="text-align:center">Make a Post!</h2>
                {% csrf_token %}
                <div class="form-group">
                  <textarea rows="3" cols="70" name="body" id="body" class="form-control" required></textarea>
                </div>
                <div id="formbutton-position">
                  <button class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-700 rounded-lg text-white" 
                  id="submit-post" type="button" 
                  style="margin-top: 10px;"> add post </button>
                </div>
              </form>
              
            </div>

            {% for post in posts %}
              <div class="container mt-3">
                <div class="row">
                  <a href="./{{post.pk}}/" class="card post-card text-decoration-none hover:shadow-lg">
                    <div class="card-body m-3">
                      <h5 class="card-title">{{post.author}}</h5>
                      <p class="card-text">{{post.isi}}</p>
                      
                      <div class="m-2 text-end">
                        <button id="like-button-{{ post.id }}" class="like-button">Like</button>
                        <span id="like-count-{{ post.id }}">{{ post.jumlah_like }}</span>
                        <button id="dislike-button-{{ post.id }}" class="dislike-button">Dislike</button>
                        <span id="dislike-count-{{ post.id }}">{{ post.jumlah_dislike }}</span>
                        <i class="bi bi-chat-right p-2">{{post.jumlah_komen}}</i>
                      </div>
                    </div>
                  </a>
                </div>
              </div>
            {% endfor %}
          </div>
      </div>

      <div class="col-lg-3 mt-5">
        <div class="card p-3">
          <a href="#">
          <p>
          Leader : {{community.leader}}
          </p>
          </a>
          <a href="/community/{{community.id}}/member">
          <p> {{community.jumlah_anggota}} Members
          </p>
        </a>

        </div>
      </div>

    </div>
  </div>
</div>
<script>
  document.getElementById('submit-post').addEventListener('click', function(e){
      e.preventDefault();
  
      var body = document.getElementById('body').value;
      var communityName = '{{ community.nama_community }}'.replace(/ /g, '%20'); // Adjust if your community names include spaces or special characters
  
      var formData = new FormData();
      formData.append('isi', body);
  
      fetch(`/post/${communityName}/create/`, {
          method: 'POST',
          body: formData,
          headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          }
      })
      .then(response => response.json())
      .then(data => {
          if(data.message === "Post berhasil dibuat"){
              window.location.href = `/post/${communityName}/${data.post_id}/`;
          } else {
              alert(data.message);
          }
      })
      .catch(error => console.error('Error:', error));
  });
  // Handling Like Button Clicks
  document.querySelectorAll('.like-button').forEach(button => {
    button.addEventListener('click', function(e) {
       e.preventDefault();
       const postId = this.id.split('-')[3];
       fetch(`/post/${postId}/like/`, {
          method: 'POST',
          headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          }
       })
       .then(response => response.json())
       .then(data => {
           if(data.status === 'success') {
               document.getElementById(`like-count-${postId}`).innerText = data.new_like_count;
           } else {
               alert(data.message);
           }
       })
       .catch(error => console.error('Error:', error));
    });
  });

  // Handling Dislike Button Clicks
  document.querySelectorAll('.dislike-button').forEach(button => {
    button.addEventListener('click', function(e) {
       e.preventDefault();
       const postId = this.id.split('-')[3];
       fetch(`/post/${postId}/dislike/`, {
          method: 'POST',
          headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          }
       })
       .then(response => response.json())
       .then(data => {
           if(data.status === 'success') {
               document.getElementById(`dislike-count-${postId}`).innerText = data.new_dislike_count;
           } else {
               alert(data.message);
           }
       })
       .catch(error => console.error('Error:', error));
    });
  });
  document.addEventListener('DOMContentLoaded', (event) => {
    var inviteButton = document.getElementById('join-button');
    if(inviteButton) {
        inviteButton.addEventListener('click', function(e){
            e.preventDefault();

            var communityName = '{{ community.nama_community }}';
            console.log(communityName);
            fetch('/community/join/', {
                method: 'POST',
                body: JSON.stringify({
                    'nama_community': communityName
                }),
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if(data.message === "User berhasil diundang"){
                    console.log(data.message); 
                    window.location.href = `/post/${communityName}/`;
                    
                } else {
                    console.log(data.message);
                }
            })
            .catch(error => console.log(error));
        });
    }
});
Toastify({
			text: message,
			duration: 3000,
			gravity: "bottom",
			position: "right",
			backgroundColor: type === "success" ? "#4CAF50" : "#F44336",
		}).showToast();
// Add your code here
  
  </script>

  
  
  
  

{% endblock content %}

