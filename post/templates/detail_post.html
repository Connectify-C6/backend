{% extends 'base.html' %} 
{% load static %} 
{% block meta %}
<title>Connectify - Post by {{post.author}}</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{% endblock meta %} 

{% block content %}
  <div class="mt-5 ml-12">
    <a href=".." class="bi bi-arrow-left" style="font-size:20px;">&nbsp;&nbsp;Return to Community</a>
  </div>
  <div class="card container mt-3">
    <div class="row">
      <div class="col">
        <div class="container">
          <div class="m-3">
            {{post.author.user.username}}
            <br> <br>   
            <p>{{post.isi}}</p>
            <br> <br>   
            Posted on {{post.created_at}} 
          </div>

          <div class="m-2">
            <button id="like-button-{{ post.id }}" class="like-button btn btn-primary btn-sm">Like</button>
          <span id="like-count-{{ post.id }}">{{ post.jumlah_like }}</span>
          <button id="dislike-button-{{ post.id }}" class="dislike-button btn btn-secondary btn-sm">Dislike</button>
          <span id="dislike-count-{{ post.id }}">{{ post.jumlah_dislike }}</span>
            <i class="btn bi bi-chat-right p-2">{{post.jumlah_komen}}</i>
          </div>
        </div>

          <div class="form-discuss py-3 px-5">
            <form method="POST" id="add-comment">
              {% csrf_token %}
              <div class="form-group">
                <label style="font-size: 20px">Add a Comment</label>
                <textarea rows="3" cols="70" name="body" id="body" class="form-control" required></textarea>
              </div>
      
              <div id="formbutton-position">
                <button class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-700 rounded-lg text-white" 
                type="submit" 
                style="margin-top: 10px;"> add comment </button>
              </div>
            </form> 
          </div>

            {% for comment in comments %}
              <div class="container m-2">
                <div class="row">
                  <div class="col">
                    <div class="card post-card text-decoration-none">
                      <div class="card-body m-3">
                        <h5 class="card-title">{{comment.author}}</h5>
                        <p class="card-text">{{comment.content}}</p>
                        <div>
                          <a href="" class="bi bi-reply m-3">&nbsp;reply</a>
                          {% if request.user.username == comment.author %}
                          <a href="" class="bi bi-trash3 m-3">&nbsp;delete</a>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
      </div>
    </div>
  </div>
</div>
<script>
  document.getElementById('like-button-{{ post.id }}').addEventListener('click', function(e) {
      e.preventDefault();
      handleLikeDislike('{{ post.id }}', 'like');
  });

  document.getElementById('dislike-button-{{ post.id }}').addEventListener('click', function(e) {
      e.preventDefault();
      handleLikeDislike('{{ post.id }}', 'dislike');
  });

  function handleLikeDislike(postId, action) {
      fetch(`/post/${postId}/${action}/`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          },
          body: JSON.stringify({
              post_id: postId,
              community_id: '{{ community.id }}'
          })
      })
      .then(response => {
        if (response.ok) {
          window.location.reload(); // Refresh the page to show updated counts
        } else {
          console.error('Error in response:', response);
        }
      })
      .catch(error => console.error('Error:', error));
  }
</script>

{% endblock content %}