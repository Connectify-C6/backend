{% extends 'base.html' %} 
{% load static %} 
{% block meta %}
<title>Connectify - Post by {{post.author.user.username}}</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
  .collapse.show {
    visibility: visible;
  }
</style>
{% endblock meta %} 

{% block content %}
<div class="container-sm">
  <div class="mt-5 ml-12">
    <a href="../../../community/{{community.nama_community}}/" class="bi bi-arrow-left" style="font-size:20px;">&nbsp;&nbsp;Return to Community</a>
  </div>
  <div class="card container mt-3">
    <div class="row">
      <div class="col">
        <div class="container">
          <div class="m-3">
          <b> {{post.author.user.username}} </b>
            <br> <br>   
            <p>{{post.isi}}</p>
            <br> <br>   
            Posted on {{post.created_at}} 
          </div>

          <div class="m-2">
            <button id="like-button-{{ post.id }}" class="like-button btn btn-primary btn-sm">Like</button>
          <span id="like-count-{{ post.id }}">{{ post.jumlah_like }}</span>
          <button id="dislike-button-{{ post.id }}" class="dislike-button btn btn-secondary btn-sm">Dislike</button>
          <span id="dislike-count-{{ post.id }}">{{ post.jumlah_dislike }}</span>
            <i class="btn bi bi-chat-right p-2">{{post.jumlah_komen}}</i>
          </div>
        </div>

        <div class="form-discuss py-3 px-5">
          <form method="POST" id="add-comment">
            {% csrf_token %}
            <div class="form-group">
              <label style="font-size: 20px">Add a Comment</label>
              <textarea rows="3" cols="70" 
                        name="body" 
                        id="comment-body" 
                        class="form-control" 
                        required></textarea>
            </div>
    
            <div id="formbutton-position">
              <button class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-700 rounded-lg text-white" 
                      id="submit-comment"
                      type="submit" 
                      style="margin-top: 10px;"> add comment </button>
            </div>
          </form> 
        </div>

        {% for comment in comments %}
          <div class="container m-2">
            <div class="row">
              <div class="col">
                <div class="card post-card text-decoration-none" id="comment-{{comment.pk}}">
                  <div class="card-body m-3">
                    <h3 class="card-title pt-2">
                      <b>{{comment.author}}</b> <br>
                      <span class="date-info text-muted">{{comment.created_at}}</span>
                    </h3>

                    <p class="card-text p-2">{{comment.content}}</p>
                    <div class="icon-group mt-1">
                      {% if user.is_authenticated %}
                      <button data-bs-toggle="collapse" 
                              href="#reply-to-{{comment.pk}}" 
                              role="button" 
                              aria-expanded="false" 
                              aria-controls="reply-to-{{comment.pk}}"
                              class="bi bi-reply m-2">&nbsp;reply</button>
                      {% endif %}

                      <button data-bs-toggle="collapse" 
                              href="#replies-comment-{{comment.pk}}" 
                              role="button" 
                              aria-expanded="false" 
                              aria-controls="replies-comment-{{comment.pk}}"
                              class="bi bi-chat m-2">&nbsp;see replies</button>

                      {% if request.user.username == comment.author %}
                      <button class="bi bi-trash3 m-2">&nbsp;delete</button>
                      {% endif %}
                    </div>

                    <div class="collapse mt-2 mx-4" id="reply-to-{{comment.pk}}">
                      <form method="POST" id="add-reply-{{comment.pk}}">
                        <textarea type="text" 
                                  name="reply-body-{{comment.pk}}"
                                  id="reply-body-{{comment.pk}}" 
                                  class="form-control" 
                                  required></textarea>
                        <button class="mt-2 px-4 py-2 bg-gray-500 hover:bg-gray-700 rounded-lg text-white" 
                                type="submit-reply" 
                                style="margin-top: 10px"
                                onclick="handleReply('{{comment.pk}}')"> send reply </button>
                      </form>
                    </div>

                    <div id="replies-comment-{{comment.pk}}" class="collapse">
                      {% if not comment.replies %}
                      <div class="card-body mt-2 px-3 pt-3 border-top">
                        <div class="mx-4">
                          <p class="pt-2">No replies yet...</p>
                        </div>
                      </div>
                      {% else %}
                        {% for reply in comment.replies %}
                          <div class="card-body mt-2 px-3 pt-3 border-top" id="reply-{{reply.pk}}">
                            <div class="mx-4">
                              <h6> <b>{{reply.author}}</b> </h6>
                              <small class="date-info text-muted">{{reply.created_at}}</small>
                              <p class="pt-2">{{reply.content}}</p>
                            </div>
                          </div>
                        {% endfor %}
                      {% endif %}
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
<script>
  document.getElementById('submit-comment').addEventListener('click', function(e) {
    e.preventDefault();
    handleComment('{{ post.id }}');
  });

  document.getElementById('like-button-{{ post.id }}').addEventListener('click', function(e) {
      e.preventDefault();
      handleLikeDislike('{{ post.id }}', 'like');
  });

  document.getElementById('dislike-button-{{ post.id }}').addEventListener('click', function(e) {
      e.preventDefault();
      handleLikeDislike('{{ post.id }}', 'dislike');
  });

  function handleComment(postId){
    fetch(`../../../comment/add-comment/${postId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            content: document.getElementById('comment-body').value
        })
    })
    .then(response => response.json())
    .then(data => {
      if (data.message === "Comment berhasil dibuat") {
        showAlert(data.message, "success");
        window.location.reload();
      } else {
        console.error('Error in response:', response);
      }
    })
    .catch(error => console.error('Error:', error));
  }

  function handleReply(commentId){
    fetch(`../../../comment/add-reply/${commentId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            content: document.getElementById(`reply-body-${commentId}`).value
        })
    })
    .then(response => {
      if (response.ok) {
        window.location.reload(); // Refresh the page
        location.href = `#replies-comment-${commentId}`;
      } else {
        console.error('Error in response:', response);
      }
    })
    .catch(error => console.error('Error:', error));
  }

  function handleLikeDislike(postId, action) {
      fetch(`/post/${postId}/${action}/`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          },
          body: JSON.stringify({
              post_id: postId,
              community_id: '{{ community.id }}'
          })
      })
      .then(response => {
        if (response.ok) {
          window.location.reload(); // Refresh the page to show updated counts
        } else {
          console.error('Error in response:', response);
        }
      })
      .catch(error => console.error('Error:', error));
  }

  function showAlert(message, type) {
		Toastify({
			text: message,
			duration: 3000,
			gravity: "bottom",
			position: "right",
			backgroundColor: type === "success" ? "#4CAF50" : "#F44336",
		}).showToast();
	}
</script>

{% endblock content %}